#!/usr/bin/env bash

# 打印当前目录
echo "Current directory: $(pwd)"

## 启动 Docker Compose 服务
#docker-compose up -d

# 启动 etcd 在后台运行，并将日志输出到文件
etcd --data-dir=./etcd-data > etcd.log 2>&1 &
ETCD_PID=$!
echo "etcd started with PID $ETCD_PID"

# 等待 etcd 启动完成
echo "Waiting for etcd to start..."
for i in {1..100}; do
    if nc -z 127.0.0.1 2379; then
        echo "etcd started successfully."
        break
    else
        echo "Waiting for etcd to start... ($i/100)"
        sleep 1
    fi
done

# 如果 etcd 未能启动，退出脚本
if ! nc -z 127.0.0.1 2379; then
    ./end
     echo "etcd failed to start. Exiting..."
    exit 1
fi

# 编译并运行服务函数
run_service() {
    local service_path=$1
    # 取路径最后两级目录作为服务名，比如 stevice/user/rpc -> user-rpc
    local dir_name=$(basename "$service_path")
    local parent_dir=$(basename "$(dirname "$service_path")")
    local service_name="${parent_dir}-${dir_name}"
    echo "Building and starting service: $service_name in $service_path"

    cd "$service_path" || { echo "Failed to cd to $service_path"; exit 1; }

    # 找到当前目录下的 go 源码文件（假设只有一个 *.go 文件，比如 user.go 或 post.go）
    local go_file=$(ls *.go 2>/dev/null | head -n1)
    if [[ -z "$go_file" ]]; then
        echo "No go file found in $service_path"
        exit 1
    fi

    go build -o "$service_name" "$go_file"
    ./"$service_name" > "../$service_name.log" 2>&1 &
    cd - >/dev/null || exit
}

# 依次启动你的服务，传入路径即可
run_service "service/user/rpc"
run_service "service/user/api"
run_service "service/post/rpc"
run_service "service/post/api"

echo "All services started successfully."