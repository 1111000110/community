#!/usr/bin/env bash

# 检查参数
CLEAN_DATA=false
if [[ "$1" == "--clean-data" ]] || [[ "$1" == "-c" ]]; then
    CLEAN_DATA=true
    echo "Data cleanup mode enabled."
fi

# 打印当前目录
echo "Current directory: $(pwd)"

# 停止并清理 Docker Compose 服务
echo "Stopping Docker Compose services..."
docker-compose down
echo "Docker Compose services stopped and cleaned."

# 停止 etcd
echo "Stopping etcd..."
pkill etcd
echo "etcd stopped."


# 停止服务进程函数
stop_service() {
    local service_name=$1
    echo "Stopping $service_name..."
    pkill "$service_name" 2>/dev/null && echo "$service_name stopped." || echo "$service_name not running."
}

# 删除文件函数，传目录和可执行文件名
clean_service() {
    local service_path=$1
    local dir_name=$(basename "$service_path")
    local parent_dir=$(basename "$(dirname "$service_path")")
    local service_name="${parent_dir}-${dir_name}"

    echo "Cleaning logs and binaries for $service_name in $service_path"

    pkill "$service_name" 2>/dev/null

    # 删除日志和二进制文件
    rm -f etcd.log
    rm -rf etcd-data

    if [[ -d "$service_path" ]]; then
        rm -f "$service_path/$service_name" "$service_path/../$service_name.log"
        echo "Cleaned $service_path/$service_name and logs."
    else
        echo "Directory $service_path does not exist."
    fi
}

# 停止对应进程（按实际进程名停止）
stop_service user-rpc
stop_service user-api
stop_service post-rpc
stop_service post-api
stop_service message-rpc
stop_service message-api

# 清理日志和二进制
clean_service "service/user/api"
clean_service "service/user/rpc"
clean_service "service/post/api"
clean_service "service/post/rpc"
clean_service "service/message/api"
clean_service "service/message/rpc"

# 数据清理功能
if [[ "$CLEAN_DATA" == true ]]; then
    echo "Cleaning Docker data volumes..."

    # 删除 Docker 数据目录
    if [[ -d "./docker-data" ]]; then
        echo "Removing Docker data directory..."
        rm -rf ./docker-data
        echo "Docker data directory removed."
    else
        echo "Docker data directory does not exist."
    fi

    # 删除 etcd 数据
    if [[ -d "./etcd-data" ]]; then
        echo "Removing etcd data directory..."
        rm -rf ./etcd-data
        echo "etcd data directory removed."
    fi

    # 删除日志文件
    echo "Removing log files..."
    rm -f *.log
    rm -f service/*/*.log
    rm -f service/*/*/*.log
    echo "Log files removed."

    echo "Data cleanup completed."
fi

echo "All services stopped and resources cleaned."

# 使用说明
if [[ "$CLEAN_DATA" == false ]]; then
    echo ""
    echo "Usage:"
    echo "  ./end              # Stop services (keep data)"
    echo "  ./end --clean-data # Stop services and clean all data"
    echo "  ./end -c           # Stop services and clean all data (short option)"
fi